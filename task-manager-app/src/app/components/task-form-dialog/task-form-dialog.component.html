<!-- タスク作成・編集ダイアログ -->
<div class="task-form-card">
  <!-- ヘッダー -->
  <div class="mat-card-header">
    <div class="mat-card-title">
      {{editTaskId ? 'タスク編集' : '新規タスク作成'}}
    </div>
    <div class="tab-row">
      <div class="tab-navigation">
        <button type="button" class="tab-button" [class.active]="selectedTab === 'TODO'" (click)="onTabChange('TODO')">TODO</button>
        <button type="button" class="tab-button" [class.active]="selectedTab === 'スケジュール'" (click)="onTabChange('スケジュール')">スケジュール</button>
      </div>
    </div>
  </div>
  <!-- 本文 -->
  <div class="mat-card-content">
    <form [formGroup]="form">
      <!-- タイトル入力 -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>タイトル</mat-label>
        <input matInput formControlName="title" placeholder="タスクのタイトルを入力" required>
      </mat-form-field>
      <!-- カテゴリー選択 -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>カテゴリー</mat-label>
        <mat-select formControlName="category" required (selectionChange)="onCategoryChange($event.value)">
          <mat-option *ngFor="let category of categories" [value]="category.id">
            {{category.name}}
          </mat-option>
          <mat-option value="__add_new__">+ 新しいカテゴリーを追加</mat-option>
        </mat-select>
      </mat-form-field>
      <div *ngIf="categoryAddMode" class="category-add-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>新しいカテゴリー名</mat-label>
          <input matInput [(ngModel)]="newCategoryName" (keydown.enter)="addCategory()" [ngModelOptions]="{standalone: true}" />
        </mat-form-field>
        <button mat-stroked-button color="primary" (click)="addCategory()">追加</button>
        <button mat-button (click)="cancelCategoryAdd()">キャンセル</button>
      </div>
      <!-- 締め切り日・締め切り時間をここに移動 -->
      <div class="date-time-container" *ngIf="selectedTab === 'TODO'">
        <mat-form-field appearance="outline" class="date-field">
          <mat-label>締め切り日</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="date">
          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>
        <mat-form-field appearance="outline" class="time-field">
          <mat-label>締め切り時間</mat-label>
          <input matInput [ngxMatTimepicker]="timePicker" formControlName="time" readonly>
          <ngx-mat-timepicker #timePicker></ngx-mat-timepicker>
        </mat-form-field>
        <mat-form-field appearance="outline" class="date-field">
          <mat-label>目標完了日</mat-label>
          <input matInput [matDatepicker]="targetPicker" formControlName="targetCompletionDate">
          <mat-datepicker-toggle matIconSuffix [for]="targetPicker"></mat-datepicker-toggle>
          <mat-datepicker #targetPicker></mat-datepicker>
        </mat-form-field>
      </div>
      <!-- 繰り返し設定（新規作成フォームと完全統一） -->
      <div class="form-section" formGroupName="repeat">
        <h3>繰り返し設定</h3>
        <mat-checkbox formControlName="enabled">繰り返し</mat-checkbox>
        <div *ngIf="form.get('repeat.enabled')?.value" class="repeat-settings">
          <mat-form-field appearance="outline">
            <mat-label>繰り返しの頻度</mat-label>
            <mat-select formControlName="frequency">
              <mat-option value="毎日">毎日</mat-option>
              <mat-option value="毎週">毎週</mat-option>
              <mat-option value="毎月">毎月</mat-option>
              <mat-option value="毎年">毎年</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- 繰り返し開始日 -->
          <mat-form-field appearance="outline">
            <mat-label>繰り返し開始日</mat-label>
            <input matInput [matDatepicker]="repeatStartPicker" formControlName="startDate">
            <mat-datepicker-toggle matSuffix [for]="repeatStartPicker"></mat-datepicker-toggle>
            <mat-datepicker #repeatStartPicker></mat-datepicker>
          </mat-form-field>

          <!-- 毎週の場合の曜日選択 -->
          <div *ngIf="form.get('repeat.frequency')?.value === '毎週'" class="weekday-selector">
            <mat-button-toggle-group formControlName="daysOfWeek" multiple>
              <mat-button-toggle [value]="0">日</mat-button-toggle>
              <mat-button-toggle [value]="1">月</mat-button-toggle>
              <mat-button-toggle [value]="2">火</mat-button-toggle>
              <mat-button-toggle [value]="3">水</mat-button-toggle>
              <mat-button-toggle [value]="4">木</mat-button-toggle>
              <mat-button-toggle [value]="5">金</mat-button-toggle>
              <mat-button-toggle [value]="6">土</mat-button-toggle>
            </mat-button-toggle-group>
          </div>

          <!-- 毎月の場合の日付選択 -->
          <mat-form-field *ngIf="form.get('repeat.frequency')?.value === '毎月'" appearance="outline">
            <mat-label>日付</mat-label>
            <mat-select formControlName="dayOfMonth">
              <mat-option *ngFor="let day of [].constructor(31); let i = index" [value]="i + 1">{{ i + 1 }}日</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- 毎年の場合の月と日の選択 -->
          <div *ngIf="form.get('repeat.frequency')?.value === '毎年'" class="yearly-repeat-settings">
            <mat-form-field appearance="outline">
              <mat-label>月</mat-label>
              <mat-select formControlName="month">
                <mat-option *ngFor="let month of [1,2,3,4,5,6,7,8,9,10,11,12]" [value]="month-1">
                  {{ month }}月
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>日</mat-label>
              <mat-select formControlName="dayOfMonth">
                <mat-option *ngFor="let day of [].constructor(31); let i = index" [value]="i + 1">{{ i + 1 }}日</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <!-- 繰り返し終了日 -->
          <mat-form-field appearance="outline">
            <mat-label>繰り返し終了日（任意）</mat-label>
            <input matInput [matDatepicker]="repeatEndPicker" formControlName="endDate">
            <mat-datepicker-toggle matSuffix [for]="repeatEndPicker"></mat-datepicker-toggle>
            <mat-datepicker #repeatEndPicker></mat-datepicker>
          </mat-form-field>
        </div>
      </div>
      <!-- 日付と時間（タブで切り替え） -->
      <div class="date-time-container" *ngIf="selectedTab === 'スケジュール'">
        <div class="no-task-section">
          <mat-checkbox formControlName="noTask">ノータスクゾーン</mat-checkbox>
          <mat-icon matTooltip="タスクを作成せずリラックスする時間帯を決めましょう">info</mat-icon>
        </div>
        <div class="date-time-fields">
          <mat-form-field appearance="outline" class="date-field">
            <mat-label>日付</mat-label>
            <input matInput [matDatepicker]="picker2" formControlName="date">
            <mat-datepicker-toggle matIconSuffix [for]="picker2"></mat-datepicker-toggle>
            <mat-datepicker #picker2></mat-datepicker>
          </mat-form-field>
          <mat-form-field appearance="outline" class="time-field">
            <mat-label>開始時間</mat-label>
            <input matInput [ngxMatTimepicker]="startTimePicker" formControlName="startTime" readonly>
            <ngx-mat-timepicker #startTimePicker></ngx-mat-timepicker>
          </mat-form-field>
          <mat-form-field appearance="outline" class="time-field">
            <mat-label>終了時間</mat-label>
            <input matInput [ngxMatTimepicker]="endTimePicker" formControlName="endTime" readonly>
            <ngx-mat-timepicker #endTimePicker></ngx-mat-timepicker>
          </mat-form-field>
        </div>
      </div>
      <!-- ラベル欄（新規作成フォームと同じスタイル） -->
      <div class="form-section">
        <h3>ラベル</h3>
        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
          <input matInput [(ngModel)]="newLabelName" placeholder="新しいラベル名" style="flex:1;" (keydown.enter)="addLabel()" [ngModelOptions]="{standalone: true}" />
          <button mat-stroked-button color="primary" type="button" (click)="addLabel()">追加</button>
        </div>
        <div class="label-container">
          <button type="button" mat-stroked-button *ngFor="let label of availableLabels"
                  (click)="toggleLabel(label)"
                  [class.selected]="isLabelSelected(label)"
                  class="label-button">
            <span class="label-color" [style.background-color]="label.color"></span>
            {{ label.name }}
          </button>
        </div>
      </div>
      <!-- 通知設定（新規作成フォームと統一） -->
      <div class="form-section">
        <h3>通知設定</h3>
        <app-notification-settings
          [settings]="notificationSettings"
          (settingsChange)="form.patchValue({ notification: $event })">
        </app-notification-settings>
      </div>
      <!-- メモ欄 -->
      <mat-form-field appearance="outline" class="full-width memo-field">
        <mat-label>メモ</mat-label>
        <textarea matInput formControlName="memo" rows="3" placeholder="詳細やメモを入力（任意）"></textarea>
      </mat-form-field>
      <!-- サブタスク入力欄 -->
      <div class="form-section">
        <h3>サブタスク</h3>
        <div class="subtask-input">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>新しいサブタスク</mat-label>
            <input matInput [(ngModel)]="newSubTaskTitle" [ngModelOptions]="{standalone: true}"
                   placeholder="サブタスクを入力" (keyup.enter)="addSubTask()">
            <button type="button" mat-icon-button matSuffix (click)="addSubTask()"
                    [disabled]="!newSubTaskTitle.trim()">
              <mat-icon>add</mat-icon>
            </button>
          </mat-form-field>
        </div>
        <div formArrayName="subTasks">
          <div *ngFor="let subTask of subTasksArray.controls; let i = index" [formGroupName]="i" class="subtask-item">
            <mat-checkbox formControlName="completed">
              {{ subTask.get('title')?.value }}
            </mat-checkbox>
            <button type="button" mat-icon-button (click)="removeSubTask(i)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </div>
      <!-- リンク欄（複数追加可） -->
      <div class="form-section">
        <h3>関連リンク</h3>
        <div formArrayName="links">
          <div *ngFor="let linkCtrl of linksArray.controls; let i = index" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>リンクURL</mat-label>
              <input matInput [formControlName]="i" placeholder="https://example.com">
            </mat-form-field>
            <button mat-icon-button color="warn" type="button" (click)="linksArray.removeAt(i)"><mat-icon>delete</mat-icon></button>
          </div>
        </div>
        <button mat-stroked-button color="primary" type="button" (click)="linksArray.push(fbPublic.control(''))">
          <mat-icon>add</mat-icon> 新しいリンクを追加
        </button>
      </div>
    </form>
  </div>
  <!-- フッター -->
  <div class="form-footer">
    <button mat-stroked-button (click)="onCancel()">キャンセル</button>
    <button mat-flat-button color="primary" [disabled]="form.invalid" (click)="onSubmit()">保存</button>
  </div>
</div> 